<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Basin Seq2One Sampling Visualization</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SamplingVisualization = () => {
            const [globalIdx, setGlobalIdx] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            
            const totalDays = 16;
            const windowSize = 5;
            const numBasins = 3;
            
            const numWindows = totalDays - windowSize + 1;
            const totalSamples = numBasins * numWindows;
            
            const idx_basin = Math.floor(globalIdx / numWindows);
            const idx_time = globalIdx % numWindows;
            
            const generateBasinData = (basinId) => {
                return Array.from({ length: totalDays }, (_, i) => ({
                    day: i + 1,
                    input: Math.sin(i * 0.3 + basinId) * 50 + 100 + Math.random() * 20,
                    runoff: Math.sin(i * 0.3 + basinId + 0.5) * 30 + 60 + Math.random() * 15
                }));
            };
            
            const basinData = Array.from({ length: numBasins }, (_, i) => generateBasinData(i));
            
            useEffect(() => {
                let interval;
                if (isPlaying && globalIdx < totalSamples - 1) {
                    interval = setInterval(() => {
                        setGlobalIdx(prev => prev + 1);
                    }, 800);
                } else if (globalIdx >= totalSamples - 1) {
                    setIsPlaying(false);
                }
                return () => clearInterval(interval);
            }, [isPlaying, globalIdx, totalSamples]);
            
            const reset = () => {
                setGlobalIdx(0);
                setIsPlaying(false);
            };
            
            const togglePlay = () => {
                if (globalIdx >= totalSamples - 1) {
                    reset();
                }
                setIsPlaying(!isPlaying);
            };
            
            const currentBasinData = basinData[idx_basin];
            const windowStart = idx_time;
            const windowEnd = idx_time + windowSize - 1;
            const targetDay = windowEnd;

            const PlayIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
            );

            const PauseIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
            );

            const RotateCcwIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
            );

            const ChevronRightIcon = () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            );

            return (
                <div className="w-full max-w-6xl mx-auto p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg">
                    <h1 className="text-3xl font-bold text-gray-800 mb-2 text-center">
                        Multi-Basin Seq2One Sampling
                    </h1>
                    <p className="text-center text-gray-600 mb-6">
                        How global index maps to (basin, time_window)
                    </p>

                    <div className="bg-white rounded-lg p-6 mb-6 shadow-md">
                        <div className="mb-4 flex items-center justify-between">
                            <h2 className="text-xl font-semibold text-gray-800">
                                Basin {idx_basin + 1} — Window {idx_time + 1}
                            </h2>
                            <div className="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded font-semibold">
                                Sample #{globalIdx}
                            </div>
                        </div>
                        
                        <div className="overflow-x-auto pb-4">
                            <div className="flex gap-1 min-w-max">
                                {currentBasinData.map((data, idx) => {
                                    const isInWindow = idx >= windowStart && idx <= windowEnd;
                                    const isTarget = idx === targetDay;
                                    const canBeTarget = idx >= windowSize - 1;
                                    const sampleNumber = canBeTarget ? idx - (windowSize - 1) : null;
                                    
                                    return (
                                        <div
                                            key={idx}
                                            className={`relative flex flex-col items-center transition-all duration-300 ${
                                                isInWindow ? 'transform scale-105' : ''
                                            }`}
                                        >
                                            <div
                                                className={`w-12 h-20 rounded-lg flex items-center justify-center text-xs font-bold transition-all ${
                                                    isTarget
                                                        ? 'bg-red-500 text-white shadow-lg ring-2 ring-red-300'
                                                        : isInWindow
                                                        ? 'bg-blue-500 text-white shadow-md'
                                                        : canBeTarget
                                                        ? 'bg-gray-200 text-gray-600'
                                                        : 'bg-gray-100 text-gray-400'
                                                }`}
                                            >
                                                {canBeTarget ? sampleNumber : '·'}
                                            </div>
                                            <div className="mt-2 text-xs text-center text-gray-600">
                                                {isTarget && <div className="font-bold text-red-600">Target</div>}
                                                {isInWindow && !isTarget && <div className="text-blue-600">Input</div>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                            <div className="flex items-center gap-4 text-sm">
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-blue-500 rounded"></div>
                                    <span>Input Days: {windowStart + 1} to {windowEnd + 1}</span>
                                </div>
                                <ChevronRightIcon />
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 bg-red-500 rounded"></div>
                                    <span>Target: Day {targetDay + 1}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg p-6 mb-6 shadow-md">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">
                            Current Sample Details (Index {globalIdx})
                        </h2>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr className="bg-gray-100">
                                        <th className="px-4 py-2 text-left">Component</th>
                                        <th className="px-4 py-2 text-left">Days</th>
                                        <th className="px-4 py-2 text-left">Shape</th>
                                        <th className="px-4 py-2 text-left">Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr className="border-t">
                                        <td className="px-4 py-2 font-semibold text-blue-600">Input X</td>
                                        <td className="px-4 py-2">{windowStart + 1}–{windowEnd + 1}</td>
                                        <td className="px-4 py-2 font-mono">({windowSize}, features)</td>
                                        <td className="px-4 py-2">Precipitation, temperature, etc.</td>
                                    </tr>
                                    <tr className="border-t bg-red-50">
                                        <td className="px-4 py-2 font-semibold text-red-600">Target Y</td>
                                        <td className="px-4 py-2">{targetDay + 1}</td>
                                        <td className="px-4 py-2 font-mono">(1,)</td>
                                        <td className="px-4 py-2">Runoff on last day</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg p-6 mb-6 shadow-md">
                        <h2 className="text-xl font-semibold text-gray-800 mb-4">
                            Sequential Sampling: All Basins All Windows
                        </h2>
                        <div className="text-sm text-gray-600 mb-4">
                            Sampling order: Basin 1 (all windows) → Basin 2 (all windows) → Basin 3 (all windows)
                            <br />
                            <span className="text-xs italic">Note: During training, these samples can be shuffled randomly in mini-batches</span>
                        </div>
                        <div className="space-y-4">
                            {basinData.map((basin, basinIdx) => (
                                <div key={basinIdx}>
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className={`w-24 text-sm font-bold px-3 py-1 rounded ${
                                            basinIdx === idx_basin 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-200 text-gray-600'
                                        }`}>
                                            Basin {basinIdx + 1}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            Days {basinIdx * totalDays}–{(basinIdx + 1) * totalDays - 1}
                                        </div>
                                    </div>
                                    <div className="flex gap-[2px]">
                                        {basin.map((_, dayIdx) => {
                                            const isCurrentBasin = basinIdx === idx_basin;
                                            const windowStart_temp = idx_time;
                                            const windowEnd_temp = idx_time + windowSize - 1;
                                            const isInWindow = isCurrentBasin && dayIdx >= windowStart_temp && dayIdx <= windowEnd_temp;
                                            const isTarget = isCurrentBasin && dayIdx === windowEnd_temp;
                                            const canBeTarget = dayIdx >= windowSize - 1;
                                            const sampleNumber = canBeTarget ? basinIdx * numWindows + (dayIdx - (windowSize - 1)) : null;
                                            
                                            return (
                                                <div
                                                    key={dayIdx}
                                                    className={`flex-1 h-16 rounded-sm transition-all flex flex-col items-center justify-center text-[10px] font-semibold ${
                                                        isTarget
                                                            ? 'bg-red-500 text-white shadow-md ring-1 ring-red-600'
                                                            : isInWindow
                                                            ? 'bg-blue-500 text-white shadow-sm'
                                                            : canBeTarget
                                                            ? 'bg-gray-200 text-gray-600'
                                                            : 'bg-gray-100 text-gray-400'
                                                    }`}
                                                >
                                                    {canBeTarget ? (
                                                        <>
                                                            <div>{sampleNumber}</div>
                                                            {isTarget && <div className="text-[8px] mt-1">T</div>}
                                                            {isInWindow && !isTarget && <div className="text-[8px] mt-1">I</div>}
                                                        </>
                                                    ) : (
                                                        <div className="text-gray-300">·</div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="mt-4 p-3 bg-indigo-50 rounded text-sm text-gray-700 text-center">
                            <strong>Total:</strong> {numBasins} basins × {numWindows} windows/basin = {totalSamples} samples
                            <div className="text-xs mt-2 text-gray-600">
                                Why {numWindows} windows per basin? Because: {totalDays} total days - {windowSize} window size + 1 = {numWindows}
                                <br />
                                First {windowSize - 1} days are warmup period (cannot form complete windows)
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-center gap-4 mb-6">
                        <button
                            onClick={togglePlay}
                            className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all shadow-md font-semibold"
                        >
                            {isPlaying ? <PauseIcon /> : <PlayIcon />}
                            {isPlaying ? 'Pause' : 'Auto Play'}
                        </button>
                        <button
                            onClick={reset}
                            className="flex items-center gap-2 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors shadow-md font-semibold"
                        >
                            <RotateCcwIcon />
                            Reset
                        </button>
                    </div>

                    <div className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg p-4 shadow-lg">
                        <div className="text-center mb-3">
                            <div className="text-xs font-semibold mb-1">GLOBAL SAMPLE INDEX</div>
                            <div className="text-4xl font-bold mb-3">{globalIdx}</div>
                            <div className="flex justify-center gap-2 mb-3">
                                <button
                                    onClick={() => setGlobalIdx(Math.max(0, globalIdx - 1))}
                                    disabled={globalIdx === 0}
                                    className="px-3 py-1 text-sm bg-white text-purple-600 rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition"
                                >
                                    ← Prev
                                </button>
                                <button
                                    onClick={() => setGlobalIdx(Math.min(totalSamples - 1, globalIdx + 1))}
                                    disabled={globalIdx === totalSamples - 1}
                                    className="px-3 py-1 text-sm bg-white text-purple-600 rounded font-semibold disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition"
                                >
                                    Next →
                                </button>
                            </div>
                        </div>

                        <div className="bg-white text-gray-800 rounded-lg p-4">
                            <div className="text-center text-xs font-bold text-purple-600 mb-3">
                                🎯 THE SAMPLING ESSENCE
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-blue-50 rounded-lg p-3 border-2 border-blue-400">
                                    <div className="font-mono text-xs text-gray-600 mb-1">idx_basin = idx // num_windows</div>
                                    <div className="text-2xl font-bold text-blue-600 text-center">
                                        {globalIdx} ÷ {numWindows} = {idx_basin}
                                    </div>
                                    <div className="text-center mt-1 text-sm font-semibold text-blue-700">
                                        → Basin {idx_basin + 1}
                                    </div>
                                </div>
                                
                                <div className="bg-green-50 rounded-lg p-3 border-2 border-green-400">
                                    <div className="font-mono text-xs text-gray-600 mb-1">idx_time = idx % num_windows</div>
                                    <div className="text-2xl font-bold text-green-600 text-center">
                                        {globalIdx} % {numWindows} = {idx_time}
                                    </div>
                                    <div className="text-center mt-1 text-sm font-semibold text-green-700">
                                        → Window {idx_time + 1}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<SamplingVisualization />, document.getElementById('root'));
    </script>
</body>
</html>